#!/bin/busybox sh

mount -t proc none /proc
mount -t sysfs none /sys

/bin/busybox --install -s 2>/dev/null

# populate /dev
mknod /dev/tty c 5 0

mdev -s

ROOTDEV="/dev/mmcblk0p2";
ROOTFSTYPE="ext4";
ROOTFSOPTS="noatime";
SPLASH=0;

# read cmdline config
ARRAY=`sed -e '/^#/d' /proc/cmdline | sed -e 's/ /\n/g' | while read line; do
        if [ ! -z ${line} ]; then
                if [ $(echo ${line} | grep "=" | wc -l) -eq 1 ]; then
                        name=${line%%=*};
                        name=${name/./_};
                        echo ${name}="${line##*=}";
                else
	                name=${line/./_};
                        echo ${name}="1";
                fi
        fi
done;`

for line in ${ARRAY}; do
	case ${line%%=*} in
		root)
			ROOTDEV=${line##*=};
		;;
		rootfstype)
			ROOTFSTYPE=${line##*=};
		;;
		rootfsopts)
			ROOTFSOPTS=${line##*=};
		;;
		splash)
			SPLASH=${line##*=}
		;;
	esac
done

# check if new root partition exists

X=0;
while [ ! -b "${ROOTDEV}" ] && [ ${X} -lt 10 ]; do
	X=$(($X+1));
	mdev -s
	sleep 1;
done;

if [ ! -b "${ROOTDEV}" ]; then
	echo "Root partition ${ROOTDEV} missing"
	exec /bin/busybox sh
	exit 0
fi

# resize root partition
if [ "${ROOTDEV}" == "/dev/mmcblk0p2" ]; then

        PART_START=$(/sbin/fdisk -l | grep mmcblk0p2 | awk '{print $2}');
        PART_END=$(/sbin/fdisk -l | grep mmcblk0p2 | awk '{print $3}');
        SDEND=$(/sbin/fdisk -l | sed -n '/mmcblk0/{n;p;}' | head -1 | awk '{print $8}');
        SDEND=$(($SDEND-1));

        if [ $SDEND -lt $PART_END ]; then

/sbin/fdisk /dev/mmcblk0 2>/dev/null >/dev/null <<EOF
d
2
n
p
2
$PART_START
$PART_END
w
EOF

        /sbin/resize2fs ${ROOTDEV}

        fi
fi

# mount root partition
mount -t ${ROOTFSTYPE} -o rw,${ROOTFSOPTS} ${ROOTDEV} /rootfs
if [ $? -ne 0 ]; then
	echo "Mounting root partition ${ROOTDEV} failed"
	exec /bin/busybox sh
	exit 0
fi

# display splash
if [ ${SPLASH} == "1" ]; then
	if [ -f "/rootfs/usr/bin/splash" ]; then
		if [ -f "/rootfs/var/splash.pid" ]; then
			rm /rootfs/var/splash.pid;
		fi
		if [ -f "/rootfs/var/splash.dat" ]; then
			rm /rootfs/var/splash.dat;
		fi
	        $(/rootfs/usr/bin/splash --percentage=12);
	fi
fi

sleep 1;

umount /proc
umount /sys

exec switch_root /rootfs /sbin/init

echo "Failed to switch_root, dropping to a shell"
exec /bin/busybox sh
